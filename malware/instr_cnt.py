from pyparsing import Word, hexnums, WordEnd, Optional, alphas, alphanums
import numpy as np
import sys
import os
import operator

fake_opcodes = ['include', 'align', 'public', 'dd', 'dw', 'assume', 'proc', 'endp', 'db', 'extrn']
path = "asm\\"
files = os.listdir(path)
# print(files)

hex_integer = Word(hexnums) + WordEnd() # use WordEnd to avoid parsing leading a-f of non-hex numbers as a hex
line = Word(alphas,alphanums)("opcode")
i = 0
opcode_dict = {}
for file in files:
    print(str(i)+"/"+str(len(files)))
    i += 1

    with open(path+file, encoding='utf8') as f1:
        source = f1.readlines()
    for source_line in source:
        if len(source_line)>17 and source_line[16] >= 'a' and source_line[16] <= 'z' and source_line[0:16]=='                ':
            result = line.parseString(source_line)
            if "opcode" in result and result.opcode not in fake_opcodes:
                if result.opcode not in opcode_dict:
                    opcode_dict[result.opcode] = 1
                else:
                    opcode_dict[result.opcode] += 1

sorted_d = dict( sorted(opcode_dict.items(), key=operator.itemgetter(1),reverse=True))
with open('statistics.txt', 'w') as f:
    f.write(str(sorted_d))
    f.write(str(len(sorted_d)))